#!/usr/bin/env groovy

node {
  taskDefImage= '020046395185.dkr.ecr.us-east-1.amazonaws.com/php-apache-image:latest'
  //def last_commit= sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
  stage 'Checkout'
  git 'https://github.com/aamirshehzad111/jenkins-git.git'
  
 
  properties([
      parameters(
         [string(defaultValue: 'cluster-one', description: 'reference cluster name', name: 'clusterValue'),
          string(defaultValue: 'vpc', description: 'vpc name', name: 'vpc'),
          string(defaultValue: 'tg', description: 'unique target group name', name: 'targetGroup'),
          //string(defaultValue: 'cluster-one', description: 'cluster name', name: 'subents')
          
         ] 
      )

  ])
  
  
  stage 'Docker build'
  docker.build('jenkins-project')
 
  stage 'Docker push'
  sh "\$(aws ecr get-login --no-include-email --region us-east-1)"
  docker.withRegistry('https://020046395185.dkr.ecr.us-east-1.amazonaws.com/jenkins-project') {
      docker.image('jenkins-project').push("latest")
     
  }
  
  

  stage('Deploy'){

  //sh "cat taskdef.json | cat > taskdef1.json"
  //sh "aws ecs register-task-definition --execution-role-arn arn:aws:iam::020046395185:role/ecsTaskExecutionRole --cli-input-json file://taskdef1.json --region us-east-1"
    withAWS(region:'us-east-1') {
       def outputs = cfnUpdate(stack: "service-stack", params: ['ClusterName': "${clusterValue}", 'ImageUrl': "${taskDefImage}",'VPC': "${vpc}", 'TG': "${targetGroup}", 'SubnetIds': "[subnet-01bae1a100abd9d9c, subnet-0f02e8a83dc4a2ac2]"],    url:'https://aamir-learning.s3.amazonaws.com/Ecs_jenkin_cf/service.yaml')
         
    }
  }

}


