#!/usr/bin/env groovy

node {
  
  //def last_commit= sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
  stage 'Checkout'
  git 'https://github.com/aamirshehzad111/jenkins-git.git'
    
 
  properties([
      parameters(
         [string(defaultValue: 'cluster-one', description: 'reference cluster name', name: 'clusterValue'),
          string(defaultValue: 'vpc-009090b7e7b0fc911', description: 'vpc id', name: 'vpc'),
          string(defaultValue: 'tg', description: 'unique target group name', name: 'targetGroup'),
          //string(defaultValue: 'app-svc', description: 'Unique Name of Service', name: 'service')
          
         ] 
      )

  ])
    //echo "current build number: ${currentBuild.number}"
    //def bulid =  "${currentBuild.number}" //echo
    //sh "${build}"
  //sh "sed -i 's/Hello! 9 commits/Bulid Number ${currentBuild.number}/g' Dockerfile" 
  
  
  stage 'Docker build'
  docker.build('jenkins-project')
 
  stage 'Docker push'
  sh "\$(aws ecr get-login --no-include-email --region us-east-1)"
  docker.withRegistry('https://020046395185.dkr.ecr.us-east-1.amazonaws.com/jenkins-project') {
      docker.image('jenkins-project').push("${currentBuild.number}")
     
  }
  image="020046395185.dkr.ecr.us-east-1.amazonaws.com/jenkins-project"
  tag="${currentBuild.number}"
  taskDefImage= "${image}:${tag}"
  echo "${taskDefImage}"
  

 /* stage('Deploy'){
    
   //echo "current build number: ${currentBuild.number}"
  //sh "cat taskdef.json | cat > taskdef1.json"
  //sh "aws ecs register-task-definition --execution-role-arn arn:aws:iam::020046395185:role/ecsTaskExecutionRole --cli-input-json file://taskdef1.json --region us-east-1"
    withAWS(region:'us-east-1') {
       def outputs = cfnUpdate(stack: "service-stack", params: ['ClusterName': "${clusterValue}", 'ImageUrl': "${taskDefImage}",'VPC': "${vpc}", 'TG': "${targetGroup}", 'BuildNumber':"${currentBuild.number}"],    url:'https://aamir-learning.s3.amazonaws.com/Ecs_jenkin_cf/service.yaml')   
    } 
    
  }  */

}


